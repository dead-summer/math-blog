---
import type { CollectionEntry } from "astro:content";

import TagList from "virtual:tylant/components/TagList";

import { BaseHead, Footer, FormattedDate, Header } from "$components";
import { kUrlBase } from "$consts";
import { postLastModified } from "$content";
import { SITE_SOURCE_URL } from "astro:env/client";

interface IdExt {
  id: string;
}

type Props = CollectionEntry<"blog">["data"] &
  (IdExt | { id: false }) & {
    canonical?: string;
    breadcrumbs: string;
  };

const {
  id,
  title,
  description,
  date,
  tags,
  author,
  breadcrumbs,
  canonical,
  lang,
  region,
} = Astro.props;
const modifiedTime = id && (await postLastModified(id));
---

<html lang={lang || "en"}>
  <head>
    <BaseHead title={title} description={description} canonical={canonical} />
    <style is:global>
      main {
        width: calc(100% - 2em);
        max-width: 100%;
        margin: 0;
      }
      .prose,
      ul.tags {
        max-width: min(56rem, calc(100% - 2em));
        color: var(--main-color);
        margin: auto;
      }
      .prose {
        padding: 1em;
      }
      .prose p {
        margin-block-start: 0.5em;
        margin-block-end: 0.5em;
      }
      .title {
        margin-bottom: 1em;
        padding: 1em 0;
        line-height: 1;
      }
      /* ===== Outline Container ===== */
      .outline-container {
        text-align: left;
      }

      /* ===== Toggle Button ===== */
      .outline-toggle {
        display: flex;
        align-items: center;
        gap: 0.5em;
        width: 100%;
        padding: 0.75em 1em;
        background: transparent;
        border: none;
        color: var(--main-color);
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .outline-toggle:hover {
        background: var(--raw-bg-color);
      }

      /* Arrow indicator */
      .outline-toggle::after {
        content: '';
        display: inline-block;
        width: 0.5em;
        height: 0.5em;
        border-right: 2px solid currentColor;
        border-bottom: 2px solid currentColor;
        transform: rotate(45deg);
        transition: transform 0.2s;
        margin-left: auto;
      }

      .outline-toggle[aria-expanded="true"]::after {
        transform: rotate(-135deg);
      }

      /* ===== Outline Content ===== */
      .outline {
        overflow: hidden;
        transition: max-height 0.3s ease, opacity 0.3s ease;
      }

      /* Collapsed state */
      .outline-container:not(.expanded) .outline {
        max-height: 0;
        opacity: 0;
      }

      .outline-container.expanded .outline {
        max-height: 80vh;
        opacity: 1;
        overflow-y: auto;
      }

      /* ===== Wide Screen Layout (≥1200px) ===== */
      @media (min-width: 1200px) {
        .outline-container {
          position: fixed;
          right: max(1rem, calc((100vw - 56rem) / 2 - 300px));
          top: 6rem;
          width: 220px;
          max-height: calc(100vh - 8rem);
          overflow-y: auto;
          border-left: 1px solid var(--raw-bg-color);
          padding-left: 1rem;
          background: var(--main-bg-color);
        }

        /* Wide screen default expanded */
        .outline-container.expanded .outline,
        .outline-container .outline {
          max-height: none;
          opacity: 1;
        }

        .outline-toggle::after {
          display: none;
        }
      }

      /* ===== Narrow Screen Layout (<1200px) ===== */
      @media (max-width: 1199px) {
        .outline-container {
          position: sticky;
          top: 0;
          z-index: 100;
          background: var(--main-bg-color);
          border-bottom: 1px solid var(--raw-bg-color);
          margin-left: calc(-50vw + 50%);
          margin-right: calc(-50vw + 50%);
          margin-bottom: 1em;
          padding: 0;
          width: 100vw;
        }

        .outline {
          padding: 0 1em 1em 1em;
          background: var(--main-bg-color);
        }

        .outline-container:not(.expanded) {
          border-bottom: none;
        }
      }
      .title h1 {
        margin: 0 0 0.5em 0;
      }
      .annotation {
        color: var(--gray-color);
        display: flex;
        gap: 0.5em;
        margin-bottom: 0.5em;
      }
      .last-updated-on {
        font-style: italic;
      }
      ul.tags {
        list-style: none;
        padding: 0;
      }
      .tags li {
        display: inline-block;
        margin: 0;
        margin-right: 1em;
      }
      .tags a {
        text-decoration: none;
      }
      .tags a:hover {
        text-decoration: underline;
      }

      /* ===== Outline Item Styles ===== */
      .outline-item {
        line-height: 1.6;
        padding: 0.25em 0;
      }
      .outline-item a {
        color: var(--accent);
        text-decoration: underline;
      }
      .outline-item a:hover {
        color: var(--accent-dark);
        text-decoration: underline solid 2px;
      }
      .outline-item.x-heading-1 {
        margin-left: 0;
        font-weight: 600;
      }
      .outline-item.x-heading-2 {
        margin-left: 0.75em;
      }
      .outline-item.x-heading-3 {
        margin-left: 1.5em;
        font-size: 0.9em;
      }
      .outline-item.x-heading-4 {
        margin-left: 2.25em;
        font-size: 0.85em;
      }
      .outline-item.x-heading-5 {
        margin-left: 3em;
        font-size: 0.85em;
      }

      /* ===== Custom Scrollbar ===== */
      .outline-container,
      .outline-container .outline {
        scrollbar-width: thin;
        scrollbar-color: transparent transparent;
      }

      .outline-container:hover,
      .outline-container:hover .outline {
        scrollbar-color: color-mix(in srgb, var(--accent) 25%, white) transparent;
      }

      /* Webkit (Chrome/Edge/Safari) */
      .outline-container::-webkit-scrollbar,
      .outline-container .outline::-webkit-scrollbar {
        width: 6px;
      }

      .outline-container::-webkit-scrollbar-thumb,
      .outline-container .outline::-webkit-scrollbar-thumb {
        background: transparent;
        border-radius: 3px;
        transition: background 0.2s;
      }

      .outline-container:hover::-webkit-scrollbar-thumb,
      .outline-container:hover .outline::-webkit-scrollbar-thumb {
        background: color-mix(in srgb, var(--accent) 25%, white);
      }

      .outline-container::-webkit-scrollbar-track,
      .outline-container .outline::-webkit-scrollbar-track {
        background: transparent;
      }
    </style>
  </head>

  <body>
    <Header breadcrumbs={breadcrumbs} />
    <main>
      <article>
        <div class="prose">
          <section class="title" aria-label="Title">
            <div class="annotation">
              <div class="date">
                <FormattedDate date={date} />
                {
                  modifiedTime && !SITE_SOURCE_URL && (
                    <>
                      <span>·</span>&#x270e;
                      <span class="last-updated-on">
                        <FormattedDate date={modifiedTime.date} />
                      </span>
                    </>
                  )
                }
                {
                  modifiedTime && SITE_SOURCE_URL && (
                    <>
                      <span>·</span>
                      <a
                        href={`${SITE_SOURCE_URL}/commit/${modifiedTime.commit}`}
                        target="_blank"
                      >
                        &#x270e;
                        <span class="last-updated-on">
                          <FormattedDate date={modifiedTime.date} />
                        </span>
                      </a>
                    </>
                  )
                }
              </div>
            </div>
            <h1>{title}</h1>
            <hr />
          </section>
          <slot />
        </div>
      </article>
      {
        tags && (
          <TagList
            baseUrl={`${kUrlBase}/article`}
            tags={tags}
          />
        )
      }
    </main>
    <Footer />
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const container = document.querySelector('.outline-container') as HTMLElement | null;
        const toggle = document.querySelector('.outline-toggle') as HTMLButtonElement | null;

        if (!container || !toggle) return;

        // Wide screen default expanded
        const mediaQuery = window.matchMedia('(min-width: 1200px)');

        function updateExpanded() {
          if (mediaQuery.matches) {
            container!.classList.add('expanded');
            toggle!.setAttribute('aria-expanded', 'true');
          } else {
            container!.classList.remove('expanded');
            toggle!.setAttribute('aria-expanded', 'false');
          }
        }

        updateExpanded();
        mediaQuery.addEventListener('change', updateExpanded);

        // Click to toggle
        toggle.addEventListener('click', () => {
          const expanded = container!.classList.toggle('expanded');
          toggle!.setAttribute('aria-expanded', String(expanded));
        });

        // Close after clicking outline item (narrow screen only)
        container.querySelectorAll('.outline-item a').forEach(link => {
          link.addEventListener('click', () => {
            if (!mediaQuery.matches) {
              container!.classList.remove('expanded');
              toggle!.setAttribute('aria-expanded', 'false');
            }
          });
        });
      });
    </script>
  </body>
</html>
